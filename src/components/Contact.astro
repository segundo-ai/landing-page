---
import { useTranslations } from "@/utils/translations";
import { site } from "@/config/site";
import { Button } from "@/components/starwind/button";
import { Card, CardContent } from "@/components/starwind/card";
import { Input } from "@/components/starwind/input";
import { Label } from "@/components/starwind/label";
import Section from "@/components/Section.astro";
import Heading from "@/components/Heading.astro";

const t = useTranslations();
---

<Section id="contact" background="muted">
    <div class="max-w-6xl mx-auto">
      <div class="grid lg:grid-cols-2 gap-12 lg:gap-16">
        <!-- Left side - Contact info -->
        <div class="space-y-8">
          <div>
            <Heading level={2} class="mb-4" data-i18n="contact.heading">
              {t("contact.heading")}
            </Heading>
            <p class="text-lg text-muted-foreground leading-relaxed satoshi-light" data-i18n="contact.description">
              {t("contact.description")}
            </p>
          </div>

          <div class="space-y-4">
            <h3 class="text-xl nohemi-medium text-foreground" data-i18n="contact.cta">
              {t("contact.cta")}
            </h3>
            <div class="space-y-3 flex flex-col items-center lg:items-start">
              <Button
                href={`mailto:${site.links.email.jose}`}
                variant="ghost"
                class="flex items-center space-x-3 group"
              >
                <svg
                  class="w-5 h-5 group-hover:scale-110 transition-transform"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                  />
                </svg>
                <span>{site.links.email.jose}</span>
              </Button>
              <Button
                href={`mailto:${site.links.email.andres}`}
                variant="ghost"
                class="flex items-center space-x-3 group"
              >
                <svg
                  class="w-5 h-5 group-hover:scale-110 transition-transform"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                  />
                </svg>
                <span>{site.links.email.andres}</span>
              </Button>
            </div>
          </div>
        </div>

        <!-- Right side - Contact form -->
        <Card class="p-6 lg:p-8 shadow-lg">
          <CardContent class="p-0">
            <form id="contact-form" class="space-y-6">
              <div class="space-y-2">
                <Label for="name" size="sm" data-i18n="contact.form.name">
                  {t("contact.form.name")}
                </Label>
                <Input
                  type="text"
                  id="name"
                  name="name"
                  required
                  placeholder="Enter your name"
                  size="md"
                />
              </div>

              <div class="space-y-2">
                <Label for="email" size="sm" data-i18n="contact.form.email">
                  {t("contact.form.email")}
                </Label>
                <Input
                  type="email"
                  id="email"
                  name="email"
                  required
                  placeholder="Enter your e-mail"
                  size="md"
                />
              </div>

              <!-- Success/Error message -->
              <div id="form-message" class="hidden"></div>

              <div class="spotlight-button-wrapper spotlight-button spotlight-container relative">
                <!-- Spotlight overlay -->
                <div class="spotlight-overlay"></div>
                <Button type="submit" variant="primary" size="lg" class="relative z-10 w-full" id="submit-button" data-i18n="contact.form.submit">
                  {t("contact.form.submit")}
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>
      </div>
    </div>
</Section>

<script>
  // Get translations from global window object (set in BaseLayout)
  function getTranslation(lang: string, key: string): string {
    const translations = (window as any).__TRANSLATIONS__ || {};
    const keys = key.split(".");
    let value: any = translations[lang];
    if (!value) return key;
    
    for (const k of keys) {
      value = value?.[k];
      if (value === undefined) return key;
    }
    return value || key;
  }

  function getCurrentLang(): string {
    return localStorage.getItem("preferred-lang") || "en";
  }

  async function handleContactFormSubmit(e: Event) {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const submitButton = document.getElementById("submit-button") as HTMLButtonElement;
    const messageDiv = document.getElementById("form-message") as HTMLDivElement;
    const lang = getCurrentLang();
    
    // Get form data
    const formData = new FormData(form);
    const data = {
      name: formData.get("name") as string,
      email: formData.get("email") as string,
    };

    // Reset message
    messageDiv.classList.add("hidden");
    messageDiv.classList.remove("text-green-600", "text-red-600");
    
    // Disable submit button and show loading state
    const originalButtonText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = getTranslation(lang, "contact.form.submitting");

    try {
      const response = await fetch("/api/contact", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        // Success
        const successMsg = getTranslation(lang, "contact.form.success");
        messageDiv.textContent = successMsg;
        messageDiv.setAttribute("data-message-type", "success");
        messageDiv.classList.remove("hidden");
        messageDiv.classList.add("text-green-600", "p-3", "rounded-md", "bg-green-50", "border", "border-green-200");
        form.reset();
      } else {
        // Error - use errorId from API to get translated error, fall back to generic error
        let errorMsg: string;
        if (result.errorId) {
          // Use errorId to construct translation key
          const errorKey = `contact.form.errors.${result.errorId}`;
          errorMsg = getTranslation(lang, errorKey);
        } else {
          errorMsg = getTranslation(lang, "contact.form.error");
        }
        messageDiv.textContent = errorMsg;
        messageDiv.setAttribute("data-message-type", "error");
        // Store the errorId so we can re-translate it on language change
        if (result.errorId) {
          messageDiv.setAttribute("data-error-id", result.errorId);
        } else {
          messageDiv.removeAttribute("data-error-id");
        }
        messageDiv.classList.remove("hidden");
        messageDiv.classList.add("text-red-600", "p-3", "rounded-md", "bg-red-50", "border", "border-red-200");
      }
    } catch (error) {
      // Network or other error
      const networkErrorMsg = getTranslation(lang, "contact.form.networkError");
      messageDiv.textContent = networkErrorMsg;
      messageDiv.setAttribute("data-message-type", "networkError");
      messageDiv.classList.remove("hidden");
      messageDiv.classList.add("text-red-600", "p-3", "rounded-md", "bg-red-50", "border", "border-red-200");
      console.error("Form submission error:", error);
    } finally {
      // Re-enable submit button
      submitButton.disabled = false;
      submitButton.textContent = originalButtonText || getTranslation(lang, "contact.form.submit");
    }
  }

  const form = document.getElementById("contact-form");
  if (form) {
    form.addEventListener("submit", handleContactFormSubmit);
  }

  // Listen for language changes to update form message
  document.addEventListener("starwind-select:change", ((event: Event) => {
    const customEvent = event as CustomEvent<{ value: string; selectId?: string }>;
    const target = event.target as HTMLElement;
    
    // Check if this is the language select - find the select element by traversing up or searching
    let selectElement: HTMLSelectElement | null = null;
    if (target?.tagName === 'SELECT' && (target as HTMLSelectElement).name === 'language') {
      selectElement = target as HTMLSelectElement;
    } else {
      // Try to find the select element in the document
      selectElement = document.querySelector('select[name="language"]') as HTMLSelectElement;
    }
    
    // Only proceed if we found the language select
    if (!selectElement || selectElement.name !== 'language') return;
    
    const selectedLang = customEvent.detail?.value;
    if (selectedLang) {
      const messageDiv = document.getElementById("form-message") as HTMLDivElement;
      
      if (messageDiv && !messageDiv.classList.contains("hidden")) {
        const messageType = messageDiv.getAttribute("data-message-type");
        if (messageType) {
          let translatedMessage: string;
          
          // For error messages, check if we have a stored errorId to re-translate
          if (messageType === "error") {
            const errorId = messageDiv.getAttribute("data-error-id");
            if (errorId) {
              // Use errorId to construct translation key
              const errorKey = `contact.form.errors.${errorId}`;
              translatedMessage = getTranslation(selectedLang, errorKey);
            } else {
              // Generic error
              translatedMessage = getTranslation(selectedLang, "contact.form.error");
            }
          } else {
            // For success and networkError, use the standard translation key
            const translationKey = `contact.form.${messageType}`;
            translatedMessage = getTranslation(selectedLang, translationKey);
          }
          
          messageDiv.textContent = translatedMessage;
        }
      }
    }
  }) as EventListener);
</script>

<style>
  .spotlight-button-wrapper {
    overflow: hidden;
    border-radius: 0.375rem; /* Match button border radius */
  }
</style>

<script>
  import { initSpotlightEffect } from '@/utils/spotlight-effect';
  import { onDOMReady } from '@/utils/dom-ready';

  // Initialize spotlight effect for contact form button
  onDOMReady(() => {
    const wrapper = document.querySelector('#contact-form .spotlight-button-wrapper') as HTMLElement;
    if (wrapper) {
      initSpotlightEffect(wrapper);
    }
  });
</script>

